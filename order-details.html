<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تفاصيل الطلب - رائد</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(180deg, #0a0a0f 0%, #1a1a2e 100%); 
            min-height: 100vh; 
            color: #fff; 
            padding: 20px; 
        }
        
        .container { max-width: 900px; margin: 0 auto; }
        
        .back-link { 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            color: rgba(255,255,255,0.6); 
            text-decoration: none; 
            margin-bottom: 30px; 
            transition: color 0.3s; 
            font-size: 15px;
        }
        .back-link:hover { color: #fff; }
        
        .page-header { margin-bottom: 40px; }
        .page-header h1 { 
            font-size: 28px; 
            margin-bottom: 10px; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        .page-header h1 i { color: #8b5cf6; }
        
        .order-number { color: #8b5cf6; font-size: 18px; }
        
        .info-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        
        .info-card { 
            background: rgba(255,255,255,0.05); 
            border-radius: 16px; 
            padding: 25px; 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .info-card h3 { 
            font-size: 16px; 
            color: rgba(255,255,255,0.6); 
            margin-bottom: 20px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .info-card h3 i { color: #8b5cf6; }
        
        .info-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
        }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: rgba(255,255,255,0.6); }
        .info-value { color: #fff; font-weight: 500; }
        .info-value.email { direction: ltr; }
        
        .items-card { 
            background: rgba(255,255,255,0.05); 
            border-radius: 16px; 
            padding: 25px; 
            border: 1px solid rgba(255,255,255,0.1); 
            margin-bottom: 30px; 
        }
        .items-card h3 { 
            font-size: 16px; 
            color: rgba(255,255,255,0.6); 
            margin-bottom: 20px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .items-card h3 i { color: #10b981; }
        
        .item-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px; 
            background: rgba(255,255,255,0.03); 
            border-radius: 10px; 
            margin-bottom: 10px; 
        }
        .item-name { font-weight: 500; }
        .item-price { color: #8b5cf6; font-weight: 600; }
        
        .total-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 20px 0; 
            border-top: 2px solid rgba(255,255,255,0.1); 
            margin-top: 20px; 
            font-size: 20px; 
            font-weight: 700; 
        }
        .total-amount { color: #10b981; }
        
        .status-section { 
            background: rgba(255,255,255,0.05); 
            border-radius: 16px; 
            padding: 25px; 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .status-section h3 { 
            font-size: 16px; 
            color: rgba(255,255,255,0.6); 
            margin-bottom: 20px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .status-section h3 i { color: #f59e0b; }
        
        .status-select { 
            width: 100%; 
            padding: 15px; 
            border-radius: 12px; 
            border: 1px solid rgba(255,255,255,0.2); 
            background: rgba(255,255,255,0.05); 
            color: #fff; 
            font-size: 16px; 
            font-family: 'Tajawal', sans-serif;
            cursor: pointer; 
        }
        .status-select option { background: #1a1a2e; }
        
        .status-badge { 
            display: inline-block; 
            padding: 8px 20px; 
            border-radius: 20px; 
            font-weight: 600; 
            font-size: 14px; 
        }
        .status-pending { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .status-processing { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .status-completed { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .status-cancelled { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        
        .save-btn { 
            width: 100%; 
            padding: 15px; 
            border-radius: 12px; 
            border: none; 
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%); 
            color: #fff; 
            font-size: 16px; 
            font-weight: 600; 
            font-family: 'Tajawal', sans-serif;
            cursor: pointer; 
            margin-top: 15px; 
            transition: all 0.3s; 
        }
        .save-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4); 
        }
        
        .loading { text-align: center; padding: 100px 20px; }
        .loading i { font-size: 50px; color: #8b5cf6; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .not-found { text-align: center; padding: 100px 20px; }
        .not-found i { font-size: 80px; color: #ef4444; margin-bottom: 20px; display: block; }
        .not-found h2 { margin-bottom: 10px; }
        .not-found p { color: rgba(255,255,255,0.6); margin-bottom: 30px; }
        .not-found a { 
            display: inline-block; 
            padding: 15px 30px; 
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%); 
            color: #fff; 
            text-decoration: none; 
            border-radius: 12px; 
            font-weight: 600;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            padding: 16px 30px;
            border-radius: 14px;
            font-weight: 600;
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.5);
            opacity: 0;
            transition: all 0.4s;
            z-index: 9999;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        @media (max-width: 600px) {
            .info-grid { grid-template-columns: 1fr; }
            .page-header h1 { font-size: 22px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="admin.html" class="back-link">
            <i class="fas fa-arrow-right"></i>
            العودة للوحة التحكم
        </a>
        
        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>جاري تحميل بيانات الطلب...</p>
        </div>
        
        <div id="notFound" class="not-found" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <h2>الطلب غير موجود</h2>
            <p>لم يتم العثور على هذا الطلب</p>
            <a href="admin.html">العودة للوحة التحكم</a>
        </div>
        
        <div id="orderContent" style="display: none;">
            <div class="page-header">
                <h1><i class="fas fa-receipt"></i> تفاصيل الطلب</h1>
                <span class="order-number" id="orderNumber"></span>
            </div>
            
            <div class="info-grid">
                <!-- Customer Info -->
                <div class="info-card">
                    <h3><i class="fas fa-user"></i> معلومات العميل</h3>
                    <div class="info-row">
                        <span class="info-label">الاسم</span>
                        <span class="info-value" id="customerName">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">البريد الإلكتروني</span>
                        <span class="info-value email" id="customerEmail">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">رقم الجوال</span>
                        <span class="info-value" id="customerPhone">-</span>
                    </div>
                </div>
                
                <!-- Order Info -->
                <div class="info-card">
                    <h3><i class="fas fa-info-circle"></i> معلومات الطلب</h3>
                    <div class="info-row">
                        <span class="info-label">رقم الطلب</span>
                        <span class="info-value" id="orderId">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">تاريخ الطلب</span>
                        <span class="info-value" id="orderDate">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">الحالة</span>
                        <span class="info-value"><span class="status-badge" id="orderStatus">-</span></span>
                    </div>
                </div>
            </div>
            
            <!-- Order Items -->
            <div class="items-card">
                <h3><i class="fas fa-shopping-cart"></i> الخدمات المطلوبة</h3>
                <div id="orderItems">
                    <!-- Items will be inserted here -->
                </div>
                <div class="total-row">
                    <span>المجموع الكلي</span>
                    <span class="total-amount" id="orderTotal">0 ريال</span>
                </div>
            </div>
            
            <!-- Status Update -->
            <div class="status-section">
                <h3><i class="fas fa-edit"></i> تحديث حالة الطلب</h3>
                <select class="status-select" id="statusSelect">
                    <option value="pending">قيد الانتظار</option>
                    <option value="processing">قيد التنفيذ</option>
                    <option value="completed">مكتمل</option>
                    <option value="cancelled">ملغي</option>
                </select>
                <button class="save-btn" onclick="saveStatus()">
                    <i class="fas fa-save"></i> حفظ التغييرات
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="database.js"></script>
    
    <script>
        let currentOrder = null;
        
        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if admin
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !isAdmin(user.email)) {
                window.location.href = 'index.html';
                return;
            }
            
            // Get order ID from URL
            const params = new URLSearchParams(window.location.search);
            const orderId = params.get('id');
            
            if (!orderId) {
                showNotFound();
                return;
            }
            
            // Load order
            await loadOrderDetails(orderId);
        });
        
        async function loadOrderDetails(orderId) {
            try {
                // Get order from Firebase
                const orderDoc = await db.collection('orders').doc(orderId).get();
                
                if (!orderDoc.exists) {
                    showNotFound();
                    return;
                }
                
                currentOrder = orderDoc.data();
                
                // Get customer info
                let customer = null;
                if (currentOrder.userEmail) {
                    customer = await getUserFromDatabase(currentOrder.userEmail);
                }
                
                // Hide loading, show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('orderContent').style.display = 'block';
                
                // Fill order info
                document.getElementById('orderNumber').textContent = '#' + currentOrder.orderNumber;
                document.getElementById('orderId').textContent = currentOrder.orderNumber;
                document.getElementById('orderDate').textContent = formatDate(currentOrder.createdAt);
                
                // Status
                const statusBadge = document.getElementById('orderStatus');
                statusBadge.textContent = getStatusText(currentOrder.status);
                statusBadge.className = 'status-badge status-' + currentOrder.status;
                document.getElementById('statusSelect').value = currentOrder.status;
                
                // Customer info
                if (customer) {
                    document.getElementById('customerName').textContent = customer.firstName + ' ' + customer.lastName;
                    document.getElementById('customerEmail').textContent = customer.email;
                    document.getElementById('customerPhone').textContent = customer.phone || 'غير متوفر';
                } else {
                    document.getElementById('customerName').textContent = 'غير معروف';
                    document.getElementById('customerEmail').textContent = currentOrder.userEmail || '-';
                    document.getElementById('customerPhone').textContent = '-';
                }
                
                // Order items
                const itemsContainer = document.getElementById('orderItems');
                if (currentOrder.items && currentOrder.items.length > 0) {
                    itemsContainer.innerHTML = currentOrder.items.map(item => `
                        <div class="item-row">
                            <span class="item-name">${item.name || item.serviceName || 'خدمة'}</span>
                            <span class="item-price">${item.price || 0} ريال</span>
                        </div>
                    `).join('');
                } else {
                    itemsContainer.innerHTML = '<p style="color: rgba(255,255,255,0.5);">لا توجد خدمات</p>';
                }
                
                // Total
                document.getElementById('orderTotal').textContent = (currentOrder.total || 0) + ' ريال';
                
            } catch (error) {
                console.error('Error loading order:', error);
                showNotFound();
            }
        }
        
        async function saveStatus() {
            const newStatus = document.getElementById('statusSelect').value;
            
            if (!currentOrder) return;
            
            const success = await updateOrderStatus(currentOrder.orderNumber, newStatus);
            
            if (success) {
                // Update badge
                const statusBadge = document.getElementById('orderStatus');
                statusBadge.textContent = getStatusText(newStatus);
                statusBadge.className = 'status-badge status-' + newStatus;
                
                showToast('تم تحديث حالة الطلب بنجاح ✅');
            } else {
                showToast('حدث خطأ أثناء التحديث ❌');
            }
        }
        
        function showNotFound() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('notFound').style.display = 'block';
        }
        
        function getStatusText(status) {
            const texts = {
                'pending': 'قيد الانتظار',
                'processing': 'قيد التنفيذ',
                'completed': 'مكتمل',
                'cancelled': 'ملغي'
            };
            return texts[status] || status;
        }
        
        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>
